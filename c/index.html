<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>stalker_portal</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script type="text/javascript" src="global.js"></script>
<script type="text/javascript" src="JsHttpRequest.js"></script>
<script type="text/javascript" src="keycodes.js"></script>
<style type="text/css">

</style>
<script language="JavaScript" type="text/javascript">

var ver = '4.0.0';
var debug = 1;
var stb;
var stbEvent;

window.onerror = function(msg, url, lno){
    _debug('line: '+lno+'; msg: "'+msg+'" url: '+url);
    return true;
}

window.onload = init;

document.addEventListener("keydown", function(event){observer.fire(event)}, false);

/**
 * Alias for document.getElementById.
 * @param {Number} id 
 * @return {*} DOMElement
 */
var $ = function(id){
    return document.getElementById(id);
}

/**
 * Init STB.
 */
function init(){
    try{
        webkit_xpcom.prototype = gSTB;
    }catch(e){}
    common_xpcom.prototype = new webkit_xpcom();
    stb = new common_xpcom();
    stb.init();
}

/**
 * Debug function.
 */
function _debug(t){
    if (debug){
        try{
            gSTB.Debug(t)
        }catch(e){}
    }
}

/**
 * XPCOM STB constructor.
 * @constructor
 */
function common_xpcom(){
    
    this.user = {};
    this.mac = '';
    this.ip  = '';
    this.hd  = 0;
    this.type  = '';
    this.version    = '';
    this.ajax_loader  = '';
    this.images   = [];
    this.storages = {};
    this.player;
    this.key_lock = 1;
    this.channels_inited = 0;
    
    //this.menu_clock = new main_menu_clock();
    
    this.init = function(){
        this.player = new player();
        this.get_stb_params();
        this.get_server_params();
        this.get_user_profile();
    }
    
    this.get_server_params = function(){
        
        var pattern = /http:\/\/([\w\.\-]*)\/([\w\/]+)*\/([\w\/]+)\/(.)*/;

        this.ajax_loader = 'http://'+document.URL.replace(pattern, "$1")+'/'+document.URL.replace(pattern, "$2")+'/server/load.php';
        
        _debug('stb.ajax_loader: '+this.ajax_loader);
    }
    
    this.get_stb_params = function (){
        
        try{
            
            this.mac = stb.RDir('MACAddress').toUpperCase().clearnl();
            
            this.ip  = stb.RDir('IPAddress').clearnl();
            
            this.type = stb.RDir('Model').clearnl();
            
            this.version = 'PORTAL version: '+ver+'; '+stb.Version();
            
            if (this.type == 'MAG200'){
                this.hd = 1;
            }else{
                this.hd = 0;
            }
        }catch(e){
            _debug(e);
        }
        
        _debug('this.mac: ' +this.mac);
        _debug('this.ip: '  +this.ip);
        _debug('this.type: '+this.type);
        _debug('this.version: '+this.version);
        _debug('this.hd: '+this.hd);
    }
    
    this.set_cookie = function(name, val){
        document.cookie = name + '=' + escape(val) + '; path=/;'
    }
    
    this.preload_images = function(){
        
        JsHttpRequest.query(
            
            this.ajax_loader,
            
            {
                'type'   : 'stb',
                'action' : 'get_preload_images'
            },
            
            function(result, errors){
                _debug(errors);
                if (result.data != null){
                    for (var i=0; i<result.data.length; i++){
                        stb.images[i] = new Image();
                        stb.images[i].src = result.data[i];
                    	stb.images.onload = function(){};
                    }
                }
            },
            
            true
        );
    }
    
    this.get_user_profile = function(){
        
        JsHttpRequest.query(
            
            this.ajax_loader,
            
            {
                'type'  : 'stb',
                'action': 'get_profile',
                'hd'    : this.hd,
                'ver'   : this.version
            },
            
            function(result, errors){
                _debug(errors);
                if (result.data != null){
                    this.user_init(result.data);
                }
            },
            
            true
        );
    }
    
    this.check_image_version = function(){
        if (this.type == 'MAG200'){
            var cur_version = stb.RDir('ImageVersion').clearnl();
            _debug('cur_version: '+cur_version);
            _debug('stb.user.image_version: '+stb.user['image_version']);
            if (cur_version != stb.user['image_version'] && stb.user['image_version'] != '0'){
                _debug('RebootDHCP');
                stb.ExecAction('RebootDHCP');
                return 0;
            }
        }
        return 1;
    }
    
    this.user_init = function(user_data){
        
        this.user = user_data;
        
        _debug('this.user: '+this.user.toSource())
        
        if (this.user['status'] == 0){
            
            if (this.type == 'MAG200'){
                if (!this.check_image_version()){
                    return;
                }
            }
            
            this.preload_images();
            
            this.player.volume_bar.set_volume(parseInt(this.user['volume']));
            
            this.user.fav_itv_on = parseInt(this.user.fav_itv_on);
            
            /*
            mount_home_dir(this.user['storages'])
            
            get_media_cats()
            
            cur_weather = this.user['cur_weather']
            
            set_updated_places(this.user['updated'])
            epg_loader.start()*/
            
            this.load_channels();
            this.load_fav_channels();
            this.load_fav_itv();
            
        }else if(this.user['status'] == 1){
            //cut_off()
        }
        //run_watchdog();
    }
    
    this.load_channels = function(){
        JsHttpRequest.query(
            
            this.ajax_loader,
            
            {
                'type'  : 'itv',
                'action': 'get_all_channels'
            },
            
            function(result, errors){
                _debug(errors);
                this.player.channels = result.data || [];
                this.channels_loaded();
            },
            
            true
        );
    }
    
    this.load_fav_channels = function(){
        JsHttpRequest.query(
            
            this.ajax_loader,
            
            {
                'type'  : 'itv',
                'action': 'get_all_fav_channels',
            },
            
            function(result, errors){
                _debug(errors);
                this.player.fav_channels = result.data || [];
                this.channels_loaded();
            },
            
            true
        );
    }
    
    this.load_fav_itv = function(){
        JsHttpRequest.query(
            
            this.ajax_loader,
            
            {
                'type'   : 'itv',
                'action' : 'get_fav_itv_ids',
            },
            
            function(result, errors){
                _debug(errors);
                this.player.fav_channels_ids = result.data || [];
                if (this.player.fav_channels_ids.length > 0){
                    this.user.fav_itv_on = 0;
                }
                this.channels_loaded();
            },
            
            true
        );
    }
    
    this.channels_loaded = function(){
        
        if (this.channels_inited){
            return;
        }
        
        if (typeof(this.player.channels) != 'undefined' &&
            typeof(this.player.fav_channels) != 'undefined' &&
            typeof(this.player.fav_channels_ids) != 'undefined'){
            
                
            if (this.user.fav_itv_on){
                this.player.f_ch_idx = this.player.fav_channels.getIdxById(this.user.last_itv_id);
                if (this.player.f_ch_idx === null){
                    this.player.f_ch_idx = 0;
                }
                var channel = this.player.fav_channels[this.player.f_ch_idx];
            }else{
                this.player.ch_idx = this.player.channels.getIdxById(this.user.last_itv_id);
                if (this.player.ch_idx === null){
                    this.player.ch_idx = 0;
                }
                var channel = this.player.channels[this.player.ch_idx];
            }
            
            this.player.show_info(channel);
            this.player.play(channel);
            
            this.key_lock = 0;
            this.channels_inited = 1;
        }
    }
    
}

/**
 * WebKit STB constructor.
 * @constructor
 */
function webkit_xpcom(){
    
    this.StandBy = function(par){
        gSTB.StandBy(par)
        panel = '.200'
        if (par){
            panel = '....'
        }
        _debug('front_panel caption ' + panel)
        gSTB.ExecAction('front_panel caption ' + panel)
    }
}

/**
 * Player constructor
 * @constructor
 */
function player(){
    
    var self = this;
    
    this.f_ch_idx = 0;
    this.ch_idx   = 0;
    this.channels;
    this.fav_channels;
    this.fav_channels_ids;
    
    this.start_time;
    this.cur_media_item;
    this.paused = 0;
    this.need_show_info = 0;
    this.pause_dom_obj = $('pause');
    
    this.init();
}

player.prototype.init = function(){
    try{
        stb.InitPlayer();
        stb.SetChromaKey(0, 0xffffff)
        stb.SetAspect(0x10);
        stb.SetPIG(1, -1, -1, -1);
        stb.SetUserFlickerControl(1);
        stb.SetDefaultFlicker(1);
        stb.SetLoop(0);
        stb.SetMicVolume(100);
        
        initEvents();
        stbEvent.onEvent = event_callback;
    }catch(e){
        _debug(e);
    }
}

player.prototype.volume_bar = new function(){
    this.volume = 100;
    this.volume_bar_dom_obj = $('volume_bar');
    
    this.set_volume = function(v){
        this.volume = v;
        stb.SetVolume(this.volume);
    }
    
    this.show = function(){
        this.volume_bar_dom_obj.show();
    }
    
    this.hide = function(){
        this.volume_bar_dom_obj.hide();
    }
    
    this.save = function(){
        JsHttpRequest.query(
        
            this.ajax_loader,
            
            {
                'type'   : 'stb',
                'action' : 'set_volume',
                'vol'    : this.volume
            },
            
            function(result, errors){
                _debug(errors);
            },
            
            true
        );
    }
};

player.prototype.seek_bar = new function(){
    
    this.seek_bar_dom_obj = $('seek_bar');
    
    this.show = function(){
        this.seek_bar_dom_obj.show();
    }
    
    this.hide = function(){
        this.seek_bar_dom_obj.hide();
    }
    
    this.set_pos = function(){
        
    }
};

player.prototype.define_media_type = function(cmd){
    
    if (cmd.indexOf('://') > 0){
        return 'stream';
    }else{
        return 'file';
    }
}

player.prototype.play = function(item){
    
    var cmd;
    
    this.cur_media_item = item;
    
    if (typeof(item) == 'object'){
        if (!item.hasOwnProperty('cmd')){
            return;
        }
        cmd = item.cmd;
    }else{
        cmd = item;
    }
    
    this.media_type = this.define_media_type(cmd);
    
    if (this.media_type == 'stream'){
        this.play_now(cmd);
    }else{
        this.create_link(item);
    }
    
}

player.prototype.create_link = function(type,uri){
    
    JsHttpRequest.query(
        
        stb.ajax_loader,
        
        {
            'type'   : type,
            'action' : 'create_link',
            'cmd'    : uri,
            'series' : ''
        },
        
        function(result, errors){
            _debug(errors);
            
        },
        
        true
    );
}

player.prototype.play_now = function(uri){
    
    this.start_time = Date.parse(new Date())/1000;

    if (this.need_show_info){
        this.show_info(cur_media_item);
    }
    
    try{
        stb.Play(uri);
    }catch(e){}
}

player.prototype.stop = function(){
    this.need_show_info = 0;
    try{
        stb.Stop();
    }catch(e){}
}

player.prototype.pause = function(){
    try{
        stb.Pause();
        this.paused = 1;
        this.pause_dom_obj.show();
    }catch(e){}
}

player.prototype.continue = function(){
    try{
        stb.Continue();
        this.paused = 0;
        this.pause_dom_obj.hide();
    }catch(e){}
}

player.prototype.show_info_after_play = function(){
    this.need_show_info = 1;
}

player.prototype.show_info = function(item){
    
}
    

/**
 * Callback for player events.
 */
function event_callback(event){
    _debug('event: '+event)
    
    switch(event){
        case 1: // End of stream
        {
            stb.player.stop();
            break;
        }
        case 4: // Playback started
        {
            
            break;
        }
    }
}


/**
 * KeyDown event observer.
 */
var observer = new function(){
    
    this.listeners = {};
    
    this.fire = function(e){
        
        var code = e.keyCode || e.which;
        
        _debug('code: '+code);
        
        if (this.listeners.hasOwnProperty(code)){
            for(var i=0; i<this.listeners[code].length; i++){
                
                var item = this.listeners[code][i];
                
                if (item.c.hasOwnProperty('con_menu')){
                    if (item.c.con_menu.on == 1){
                        continue;
                    }
                }
                
                if (item.c.on == 1 || item.c === window){
                    item.f.apply(item.c, item.a);
                    return;
                }
            }
        }
    }
}

/**
 * Binding function to key.
 * @param {number} key
 * @param {Object} context The object to be used as the value of 'this' within 'f'
 * @param {*} args
 * @return {Function}
 */
Function.prototype.bind = function(key, context, args){
    context = context || window;
    observer.listeners[key] = observer.listeners[key] || [];
    args = Array.prototype.splice.apply(arguments, [2, arguments.length]);
    observer.listeners[key].unshift({'f' : this, 'c' : context, 'a' : args});
    return this;
}


/**
 * Layer constructor
 * @constructor
 */
function Layer(){
    
    this.name = 'Layer';
    this.on = 0;
    
    this.cur_row = 0;
    this.prev_row = 1;
    this.cur_page = 0;
    this.total_pages = 0;
    
    this.con_menu_action = [];
    this.con_menu_on = 0;
    this.con_menu_cur_row = 0;
    this.con_menu_prev_row = 0;
    
    this.col_ids = [];
    
    this.layer_dom_obj = $('layer_'+this.name);
    
    this.shift_row.bind(key.UP,   this, -1);
    this.shift_row.bind(key.DOWN, this,  1);
    
    this.shift_page.bind(key.PAGE_PREV, this, -1);
    this.shift_page.bind(key.PAGE_NEXT, this,  1);
}

Layer.prototype.show = function(){
    _debug(this.name + ' show');
    
    this.layer_dom_obj.show();
    this.on = 1;
}

Layer.prototype.hide = function(){
    _debug(this.name + ' hide');
    
    this.layer_dom_obj.hide();
    this.on = 0;
}

Layer.prototype.shift_row = function(dir){
    _debug(this.name + ' shift_row ' + dir);
    
}

Layer.prototype.shift_page = function(dir){
    _debug(this.name + ' shift_page ' + dir);
    
}

Layer.prototype.set_active_row = function(){
    _debug(this.name + ' set_active_row');
    
}

Layer.prototype.set_passive_row = function(){
    _debug(this.name + ' set_passive_row');
    
}

Layer.prototype.set_passive_all_rows = function(){
    _debug(this.name + ' set_passive_all_rows');
    
}

Layer.prototype.load = function(p){
    _debug(this.name + ' load ' + p);
    
}

Layer.prototype.fill_rows = function(arr){
    _debug(this.name + ' fill_rows ' + arr.toSource());
    
}

Layer.prototype.del_rows = function(arr){
    _debug(this.name + ' del_rows ');
    
}



</script>
</head>
<body>

</body>
</html>