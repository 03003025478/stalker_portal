{% extends 'layout.twig' %}
{% import '/macro/iptw_macro.twig' as main_macro %}
{% set title = 'tasks' %}

{% block content %}
{#    <div class="row header_title">
        <div class="col-xs-10 col-sm-6">
            <h3>История задания №{{ app['task_num'] }} из раздела "{{ app['taskTypeTitle'] }}"</h3>
        </div>
    </div>#}
    <div id="iptv_list">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="box col-xs-6 col-sm-8">
                    <div class="box-content">
                        <div class="box-content no-padding"  id="task_chat">
                            <div class="col-sm-12 one-list-message bg-{{app['taskStateColor'][0]}}">
                                <div class="col-xs-1 checkbox">
                                    <label>{{ app['creator']}}</label>
                                </div>
                                <div class="col-xs-9 message-title"><b>Создал задание №{{ app['task_num'] }}</b></div>
                                <div class="col-xs-2 message-date">{{ app['added']|date('M d, Y H:i') }}</div>
                            </div>
                            {% for row in app['taskAll']%}
                                
                                {% if attribute(row,'comment') is defined %}
                                {% if row['readed'] == "0" %}
                                    {% if row['from_usr'] == app['toLeft'] %}
                                        {% set add_class = 'bg-default pull-left' %}
                                    {% else %}
                                        {% set add_class = 'bg-default pull-right' %}
                                    {% endif %}
                                {% else %}
                                    {% if row['from_usr'] == app['toLeft'] %}
                                        {% set add_class = 'pull-left' %}
                                    {% else %}
                                        {% set add_class = 'pull-right' %}
                                    {% endif %}
                                {% endif %}
                                <div class="col-sm-9 one-list-message {{add_class}}">
                                    <div class="col-xs-1 checkbox no-padding">
                                        <label>{{ row['from_usr_login']}}</label>
                                    </div>
                                        <div class="col-xs-9 message-title">{% if row['readed'] == "0" %}<b>Сообщение еще не прочитанно</b>{% endif %}<p>{{ row['comment'] }}</p></div>
                                    <div class="col-xs-2 message-date">{{ row['send_time']|date('M d, Y H:i') }}</div>
                                </div>
                                {% endif %}
                                {% if loop.last %}
                                    {% if row.state != 0 %}
                                <div class="col-sm-12 one-list-message bg-{{ app['taskStateColor'][row.state] }}">
                                    <div class="col-xs-9 message-title"><b>Задание {{ app['taskAllState'][row.state]['title']|lower }}</b></div>
                                    <div class="col-xs-2 message-date">{{ row['end_time']|date('M d, Y H:i') }}</div>
                                </div>
                                    {% endif %}
                                    {% if row.archived != "0" %}
                                <div class="col-sm-12 one-list-message bg-default">
                                    <div class="col-xs-9 message-title"><b>Задание выведено в архив</b></div>
                                    {% if row['archived_time'] %}
                                    <div class="col-xs-2 message-date">{{ row['archived_time']|date('M d, Y H:i') }}</div>
                                    {% endif %}
                                </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                        </div>
                        {% if app['showForm'] %}
                        <div class="box-content no-padding" id="task_chat_panel">
                            <div class="row">
                                <form class="form-horizontal" method="POST" role="form" id="task_form" action="{{ app.request.baseUrl }}/{{ app.controller_alias }}/send-task-message-{% if app['task_type'] == 'karaoke' %}karaoke{% else %}video{% endif %}">
                                    <div class="form-group">
                                        {% if app['showInput'] %}
                                        <label class="col-sm-2 control-label col-xs-offset-1">Сообщение</label>
                                        {% endif %}
                                        <div class="col-xs-10 col-sm-9 no-padding">
                                            <div class=" col-xs-11 col-sm-11 ">
                                                <input type="hidden" name="recipientID" class="own_fields" value="{{ app['recipientID'] }}">
                                                <input type="hidden" name="taskid" class="own_fields" value="{{ app['taskID'] }}">
                                                <input type="hidden" name="selfID" class="own_fields" value="{{ app['selfID'] }}">
                                                <input type="hidden" name="task_type" class="own_fields" value="{{ app['task_type'] }}">
                                                <input type="hidden" name="reply_to" value="{{ app['replyTo'] }}">
                                                <input type="hidden" name="apply" value="">
                                                {% if app['showInput'] %}
                                                <input type="text" name="message" class='own_fields form-control'>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-8 pull-right">
                                        <button type="submit" class="btn btn-success col-sm-3 pull-right" data-value="ended">Готово</button>
                                        {% if app['showInput']%}
                                        <button type="submit" class="btn btn-danger col-sm-3 pull-right" data-value="rejected">Отклонить</button>
                                        <button type="submit" class="btn btn-default col-sm-3  pull-right" data-value="message">Ответить</button>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if attribute(app, 'infoTable') is defined%}
                <div class="box col-xs-6 col-sm-4">
                    <div class="box-content">
                        <div class="box-content no-padding">
                            <div class="row one-list-message">
                                <div class="col-xs-4 checkbox">
                                    {% if attribute(app, 'creator') is defined%}
                                    <label>{{ app['creator'] }}</label>
                                    {% endif %}
                                </div>
                                <div class="col-xs-5 message-title">
                                    <b>{{ app['taskAllState'][0]['title'] }}</b> 
                                </div>
                                <div class="col-xs-3 message-date">{{ app['added']|date('M d, Y H:i') }}</div>
                                <div class="col-xs-12 message-title">
                                    </br></br>
                                    <table class="table table-bordered">
                                        {% autoescape false %}
                                        {% for key, value in app['infoTable'] %}
                                        <tr>
                                            <td>{{ key }}</td>
                                            <td>{{ value }}</td>
                                        </tr>
                                        {% endfor %}
                                        {% endautoescape %}
                                    </table>
                                    </br></br>
                                </div>
                                    {% if attribute(app, 'comment') is defined%}
                                <div class="col-xs-12 message-title">
                                    <label>Коментарий создателя:</label>
                                    </br></br>
                                    <p>
                                        {{ app['comment'] }}
                                    </p>
                                </div>
                                    {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
                                    
    <script type="text/javascript" defer>


        function yelp() {
            $(document).ready(function () {
                $("#task_chat").height($(window).height()*2/3);
                $(document).on('click', "a.main_ajax[disabled!='disabled']", function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    var sendData = $(this).data();
                    ajaxPostSend($(this).attr('href'), sendData, false, false);
                    $(this).closest('div.open').removeClass('open');
                    return false;
                });
               
                $(document).on('click', '#task_form button',function(){
                    $("#task_form input[name=apply]").val($(this).data('value'));
                });
               
            });
        }

        document.addEventListener("DOMContentLoaded", yelp, false);
        
        var manageTasks = function (obj) {

        }
        
    </script>
{% endblock %}