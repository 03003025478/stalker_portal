{% extends 'layout.twig' %}
{% set title =  'Certificate request' %} {#('Radio'|trans ~ ': ' ~ (app.radioEdit ? ('Edit radio'|trans ~ " '"~ app.radioName ~ "'"): 'Add radio'|trans)) | trans#}

{% block content %}

    <div id="add_channel">
        {{ form_start(app['form'], {'method': 'POST', 'action': (app.request.baseUrl ~ '/' ~ app.controller_alias  ~ '/certificate-request') | trans, 'attr': {'class': 'form-horizontal', 'role': 'form', 'id': 'form_'}}) }}
        <div class="bg-danger">
            {{ form_errors(app['form']) }}
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10 col-lg-offset-1 col-md-offset-1">
                <div class="box">
                    <div class="box-content">
                        <div class="form-group"  {{ (app.is_show ? '' : 'style="display: none;"') }}>
                            <label class="col-sm-2 control-label ">{{ 'ID'|trans }}</label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].id, {'attr': {'class': 'form-control', 'readonly': 'readonly'}}) }}
                                    <div></div>
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].id) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group"  {{ (app.is_show ? '' : 'style="display: none;"') }}>
                            <label class="col-sm-2 control-label ">{{ 'ID Stalker Miidleware'|trans }}</label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].stalker_id, {'attr': {'class': 'form-control', 'readonly': 'readonly'}}) }}
                                    <div></div>
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].stalker_id) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label ">{{ 'Contact person'|trans }}<span class="icon-required">*</span></label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].contact_name, {'attr': {'class': 'form-control', 'data-validation': 'custom', 'data-validation-regexp': '^[а-яА-ЯёЁa-zA-Z ]{3,25}$' }}) }}
                                    <div></div>
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].contact_name) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label ">{{ 'Contact info'|trans }}<span class="icon-required">*</span></label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].contact_address, {'attr': {'class': 'form-control', 'placeholder': 'mail@example.com'}}) }} {#, 'data-validation': 'custom', 'data-validation-regexp': '^[а-яА-ЯёЁa-zA-Z0-9@ ]{3,25}$'#}
                                    <div></div>
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].contact_address) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label ">{{ 'Number of licenses'|trans }}</label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].quantity, {'attr': {'class': ('populate placeholder' ~ (app.is_show ? ' disabled': '')) | trans} }) }}
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].quantity) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label ">{{ 'Period of validity'|trans }}</label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].period, {'attr': {'class': 'populate placeholder'} }) }}
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].period) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label ">{{ 'Begin of certificate validity'|trans }}</label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].date_begin, {'attr': {'class': 'populate placeholder col-md-12', 'data-validation': 'date', 'data-validation-format': 'dd.mm.yyyy'} }) }}
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].date_begin) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label ">{{ 'Server host'|trans }}<span class="icon-required">*</span></label>
                            <div class="col-xs-10 col-sm-8">
                                <div class=" col-xs-10 col-sm-6">
                                    {{ form_widget(app['form'].server_host , {'attr': {'class': 'form-control' }}) }} {#, 'data-validation': 'custom', 'data-validation-regexp': '^[а-яА-ЯёЁa-zA-Z ]{3,25}$'#}
                                    <div></div>
                                </div>
                                <div>
                                    <div class="bg-danger">
                                        {{ form_errors(app['form'].server_host ) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if app.is_show %}
                            <div class="form-group">
                                <label class="col-sm-2 control-label ">{{ 'End of certificate validity'|trans }}</label>
                                <div class="col-xs-10 col-sm-8">
                                    <div class=" col-xs-10 col-sm-6">
                                        {{ form_widget(app['form'].date_to, {'attr': {'class': 'populate placeholder col-md-12'} }) }}
                                    </div>
                                    <div>
                                        <div class="bg-danger">
                                            {{ form_errors(app['form'].date_to) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label "></label>
                                <div class="col-xs-10 col-sm-8">
                                    <div class=" col-xs-10 col-sm-6">
                                        {{ form_widget(app['form'].expire, {'attr': {'class': 'populate placeholder col-md-12'} }) }}
                                        {% if app['form'].expire.vars.value < 35  %}
                                            {{ form_widget(app['form'].save, { 'label': 'Request a new certificate'|trans , attr: {'class': 'btn btn-default pull-right'}}) }}
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="bg-danger">
                                            {{ form_errors(app['form'].expire) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label ">{{ 'Status'|trans }}</label>
                                <div class="col-xs-10 col-sm-8">
                                    <div class=" col-xs-10 col-sm-6">
                                        {{ form_widget(app['form'].status, {'attr': {'class': 'populate placeholder col-md-12'} }) }}
                                    </div>
                                    <div>
                                        <div class="bg-danger">
                                            {{ form_errors(app['form'].status) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% if not(app.is_show) %}
                <div class="box">
                    <div class="box-content">
                        <div class="row">
                            <div class="pull-right">
                                {{ form_widget(app['form'].save, { 'label': 'Request'|trans , attr: {'class': 'btn btn-success pull-right'}}) }}
                                <a id="form_reset" href="{{app.request.baseUrl}}/{{app.controller_alias}}" class="btn btn-default pull-right">{{ 'Cancel'|trans }}</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div style="display: none;">
            {{ form_rest(app.form) }}
        </div>
        {{ form_end(app['form']) }}
    </div>
    <script type="text/javascript" defer>

        var allLicenseCountAndCost = JSON.parse('{% autoescape false %}{{ app.allLicenseCountAndCost|json_encode() }}{% endautoescape %}');
        var allLicensePeriodAndDiscount = JSON.parse('{% autoescape false %}{{ app.allLicensePeriodAndDiscount|json_encode() }}{% endautoescape %}');

        var select2Opt = {minimumResultsForSearch: -1, dropdownAutoWidth: false, width: '100%'};

        var conf = {
            form: '#form_',
            lang : '{{ app.language }}',
            showHelpOnFocus : true,
            validateHiddenInputs: true,
            modules: 'jsconf',
            onSuccess: function () {
                $(conf.form).find(':disabled').prop('disabled', false).removeAttr('disabled');
                $(conf.form).get(0).submit();
                return true;
            },
            onError: function () {
                return false;
            }
        };

        function DemoSelect2() {
            $('select').select2(select2Opt);
        }

        function yelp() {
            $(document).ready(function () {


                $.validate(conf);

                if (allLicenseCountAndCost && allLicenseCountAndCost.length != 0) {
                    for (var i in allLicenseCountAndCost ) {
                        var opt = $("#form_quantity option[value='"+i+"']");
                        opt.data({cost: allLicenseCountAndCost[i].cost}).html(opt.html() + ' (' + allLicenseCountAndCost[i].cost + '$)');
                    }
                }
                if (allLicensePeriodAndDiscount && allLicensePeriodAndDiscount.length != 0) {
                    for (var i in allLicensePeriodAndDiscount ) {
                        var opt = $("#form_period option[value='"+i+"']");
                        opt.data({discount: allLicensePeriodAndDiscount[i].discount}).text(opt.text() + ' (' + allLicensePeriodAndDiscount[i].discount + '%)');
                    }
                }

                $("#form_save").on('click', function (e) {
                    e.stopPropagation();
                    e.preventDefault();

                    if ($(conf.form).isValid({}, conf, true)) {
                        conf.onSuccess();
                    } else {
                        conf.onError();
                    }
                    return false;
                });

                LoadSelect2Script(DemoSelect2);
                $("#form_date_begin").datepicker({
                    numberOfMonths: 1,
                    language: '{% if attribute(app, 'language') is defined %}{{ app.language }}{% else %}en{% endif %}',
                    dateFormat: 'dd.mm.yy',
                    minDate: new Date(),
                    dayNamesMin: [
                        '{{ 'Sun'|trans }}',
                        '{{ 'Mon'|trans }}',
                        '{{ 'Tue'|trans }}',
                        '{{ 'Wed'|trans }}',
                        '{{ 'Thu'|trans }}',
                        '{{ 'Fri'|trans }}',
                        '{{ 'Sat'|trans }}'
                    ],
                    monthNames: [
                        '{{ 'January'|trans }}',
                        '{{ 'February'|trans }}',
                        '{{ 'March'|trans }}',
                        '{{ 'April'|trans }}',
                        '{{ 'May'|trans }}',
                        '{{ 'June'|trans }}',
                        '{{ 'July'|trans }}',
                        '{{ 'August'|trans }}',
                        '{{ 'September'|trans }}',
                        '{{ 'October'|trans }}',
                        '{{ 'November'|trans }}',
                        '{{ 'December'|trans }}'
                    ],
                    onClose: function(){}
                }).attr('readonly', 'readonly');
            });
        }
        document.addEventListener("DOMContentLoaded", yelp, false);

    </script>
{% endblock %}